<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="xasset RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="xasset Atom Feed"><title data-react-helmet="true">老问题的原因与新机制的改进 | xasset</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://xasset.pro//blog/the-important-things"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="老问题的原因与新机制的改进 | xasset"><meta data-react-helmet="true" name="description" content="“全量包打包后，安装包覆盖更新在5.1会有加载错误的bug，2022版是否已经清除了这个bug？”"><meta data-react-helmet="true" property="og:description" content="“全量包打包后，安装包覆盖更新在5.1会有加载错误的bug，2022版是否已经清除了这个bug？”"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2021-12-22T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/mmdnb"><meta data-react-helmet="true" property="article:tag" content="xasset"><link data-react-helmet="true" rel="shortcut icon" href="../../img/logo.png"><link data-react-helmet="true" rel="canonical" href="https://xasset.pro//blog/the-important-things"><link data-react-helmet="true" rel="alternate" href="https://xasset.pro//blog/the-important-things" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://xasset.pro//blog/the-important-things" hreflang="x-default"><link rel="stylesheet" href="../../assets/css/styles.e67c487e.css">
<link rel="preload" href="/assets/js/runtime~main.c4241613.js" as="script">
<link rel="preload" href="/assets/js/main.57288477.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" role="banner"><div class="announcementBarPlaceholder_2m9F"></div><div class="announcementBarContent_3EUC">⭐️ <a target="_blank" rel="noopener noreferrer" href="../../docs/changes/index.html">2022 版本</a> 已经可用。如果你喜欢 xasset, 请在 <a target="_blank" rel="noopener noreferrer" href="https://github.com/xasset/xasset">GitHub</a> 给一个星标！</div><button type="button" class="clean-btn close announcementBarClose_38nx" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"/></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class="navbar__brand" href="../../index.html"><div class="navbar__logo"><img src="../../img/logo.png" alt="xasset logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="../../img/logo.png" alt="xasset logo" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">xasset</b></a><a class="navbar__item navbar__link" href="../../docs/about/index.html">文档</a><a class="navbar__item navbar__link" href="../../price/index.html">价格</a><a class="navbar__item navbar__link" href="../../compares/index.html">比较</a><a class="navbar__item navbar__link" href="../../license/index.html">许可</a><a class="navbar__item navbar__link" href="../../jobs/index.html">工作</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/xasset/xasset" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">🌜</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">🌞</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a aria-current="page" class="sidebarItemLink_1RT6 sidebarItemLinkActive_12pM" href="index.html">老问题的原因与新机制的改进</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="../success-story/index.html">xasset 2022 发布的亮点是什么</a></li></ul></nav></aside><main class="col col--7" itemscope itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_GeHD" itemprop="headline">老问题的原因与新机制的改进</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2021-12-22T00:00:00.000Z" itemprop="datePublished">December 22, 2021</time> · <!-- -->6 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/mmdnb" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://github.com/mmdnb.png" alt="MoMo的奶爸"></a><div class="avatar__intro" itemprop="author" itemscope itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/mmdnb" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">MoMo的奶爸</span></a></div><small class="avatar__subtitle" itemprop="description">xasset 创始人</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><em>“全量包打包后，安装包覆盖更新在5.1会有加载错误的bug，2022版是否已经清除了这个bug？”</em></p><p>也不确定这位老用户是否看明白，我非常肯定的回答道：</p><p><em>“2022 的版本管理机制使用时间戳 + 带 hash 的文件名，没有在代码中维护资源的版本状态，而是通过只读的清单维护的，在版本管理这块的稳定性和效率，是得到前所未有的提升。”</em></p><p>为什么我是如此确信 2022 版本的 xasset 在版本管理这块是得到前所未有的提升呢？如果之前说的过于抽象，这里我重新梳理下：</p><p>过去，在 5.1 版本或之前的 xasset 上，对于资源的版本管理是一种基于版本号驱动的管理机制，打包后输出的文件的文件名，是不带文件内容的版本信息（哈希值）。这时，为了确保资源不被 CDN 同名缓存的问题所影响，资源部署到 CDN 上时需要用带版本号的目录结构来管理，例如：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#FFFFFF;background:#282C34"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">app</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">└─android</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    ├─v1.0.0</span><br></span><span class="token-line" style="color:#FFFFFF;background:#282C34"><span class="token plain">    └─v1.0.1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>在运行时初始化的时候，xasset 内部会读取版本号判断是否覆盖安装，而这个版本号有个非常大的弊端就是，如果删除历史打包文件，版本号会重置，这样新包的版本号可能会比旧包的版本号低，这时候就可能导致出现新包跑旧资源的情况了，也就是老用户强调的那个“全量包打包后，安装包覆盖更新在5.1会有加载错误的bug”的问题。</p><p>尽管在不删除历史打包文件的时候，这种过时的基于版本号驱动的版本管理机制也不会出现啥问题。然而，也不能忽视他所带来的弊端，——抛开每次上传 CDN 都是全量上传，需要浪费多少部署的等待时间和网络存储空间不说，一旦版本号重置了，覆盖安装就可能会出现加载错误的bug。</p><p>有没有什么办法可以不管用户是否删除历史打包数据也能正常加载最新版本的资源？有没有什么办法可以达成增量部署的目的？我不断在反思，也总算找到了可以说是目前最好的方案，这就是 xasset 2022 所采用的时间戳 + 带 hash 的文件名的版本管理方案。</p><p>为什么需要时间戳呢？新包的hash 和老包的hash 应该不一样，这个不能用清单服务器管理么？ 也许有人会这样反问，但是，在提这个问题之前需要进一步思考的是：怎么比较新旧呢？你如何区分 apk 内部的 和 下载目录的版本文件的新旧关系？</p><p>例如，覆盖安装的时候，本来是个新包，包含了部分最新的资源，如果你直接去加载下载目录的这不就会造成新包加载旧资源么？你不加载的话，更新后的内容什么时候呈现在游戏中呢？等和服务器通信后？而时间戳，不管你是否删除历史数据都会更新，是不是要比版本号稳的多？</p><p>除了使用时间戳外，打包输出的文件的文件名自带文件内容的版本信息，资源部署到 CDN 时，可以把多个版本的文件放到同一个目录，天生不会存在同名缓存问题，也就没有必要全量上传了，更新了哪些才上传哪些，时间和空间都得到更高效的利用。</p><p>同时，xasset 2022 在运行时更新资源的时候，也可以直接通过文件名和文件的长度判断文件是否存在，从而跳过开销更大耗时更长的内容比较的过程，自然更快。并且，更不用通过额外编码反复读写资源的版本状态，而少一次写入就少一次变化，没有变化，自然更稳定。</p><p>增量部署、快速校验、状态只读不易变，不论是否登峰造极，这就是 xasset 2022 版本管理机制全面提升的重点，满意请点赞，不满意可以留言拍砖。</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_3kfx"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="../tags/xasset/index.html">xasset</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/mmdnb/xasset-website/edit/main/blog/2021-12-22-老问题的原因与新机制的改进.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="../success-story/index.html"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">xasset 2022 发布的亮点是什么<!-- --> »</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">xasset</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="../../docs/about/index.html">关于</a></li></ul></div><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/xasset" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></span></a></li><li class="footer__item"><a href="https://jq.qq.com/?_wv=1027&amp;k=I2gC9wKu" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>QQ 群<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="../index.html">Blog</a></li><li class="footer__item"><a href="https://github.com/xasset/xasset" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">版权所有 © 2022 xasset.pro。使用 Docusaurus 构建。</div></div></div></footer></div>
<script src="../../assets/js/runtime~main.c4241613.js"></script>
<script src="../../assets/js/main.57288477.js"></script>
</body>
</html>